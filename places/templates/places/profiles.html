{% extends 'base.html' %}
{% load markup %}

<title>{% block title %}{{ place.name }} Health Profile{% endblock %}</title>

{% block head_javascript %}

{{ block.super }}

{% include "visualizations/_swfobject.html" %}

<script type="text/javascript">
jQuery(document).ready(function($) {

{% if slots.count %}

{% for slot in slots %}
    {% with vis=slot.visualization %}
    swfobject.embedSWF(
      "{{ WEAVE_URL }}weave.swf", 
      "profile-swf-div-{{ forloop.counter0 }}", 
      {{ slot.width }}, {{ slot.height }}, 
      "10.0.0",
      "expressInstall.swf", 
      {
		file: "http://{{ CURRENT_SITE.domain }}{% url visualizations.views.visualization_xml vis.id place.id %}"
	  }, 
      HEMA.swfobject.params,
      {
        id: "profile-swf-div-{{ forloop.counter0 }}",
        name: "profile-swf-div-{{ forloop.counter0 }}"
      }
    );
    {% endwith %}
{% endfor %}

{% else %}

{% for row in visualization_rows %}
  {% for slot in row %}
    {% with vis=slot.visualization %}
      {% if slot.ok %}
    swfobject.embedSWF(
      "{{ WEAVE_URL }}weave.swf", 
      "{{ slot.name }}", 
      {{ slot.get_width|safe }}, {{ slot.get_height|safe }}, 
      "10.0.0",
      "expressInstall.swf", 
      {
		file: "http://{{ CURRENT_SITE.domain }}{% url visualizations.views.visualization_xml vis.id place.id %}"
	  }, 
      HEMA.swfobject.params,
      {
        id: "{{ slot.name }}",
        name: "{{ slot.name }}"
      }
    );

      {% endif %}
    {% endwith %}
  {% endfor %}
{% endfor %}

{% endif %}

    // Flash available
    if (swfobject.getFlashPlayerVersion()["major"] > 0) {
        $(".swfobject-container-div p:first").remove();
    }
});
</script>

{% endblock %} 

{% block bodyclass %}
<body class="profile">
{% endblock %} 

{% block content %}  

<div class="span9">
<h2>Health Profile: {{place.name}}</h2>
<div class="place_profile">{{place.profile|markdown}}</div>
<div id="place_map"></div>

</div>
{% if slots.count %}

{% for slot in slots %}
{% if forloop.first %}<div class="row-of-visualizations">{# new_row or not #}
{% else %}{% if slot.new_row %}</div>
<div class="row-of-visualizations">
{% endif %}{% endif %}
{% if slot.new_row and slot.title %}<h2>{{ slot.title }}</h2>{% endif %}
<div id="profile-swf-div-{{ forloop.counter0 }}"
   class="swfobject-container-div profile-slot-{{ slot.name|slugify }}">
{% with vis=slot.visualization %}
{% if vis.visualization.thumbnail %}
<img src="{{ MEDIA_URL }}{{ vis.visualization.thumbnail }}" alt="">
{% endif %}
<p>Please install the
<a href="http://get.adobe.com/flashplayer/">Adobe Flash Player</a>
to interact with this visualization.</p>
{% endwith %}
</div>
{% endfor %}

{% else %}

{% for row in visualization_rows %}
<div class="row-of-visualizations">
{% if row.0.title %}<h2>{{ row.0.title }}</h2>
{% endif %}
{% for slot in row %}
<div id="{{ slot.name }}" class="swfobject-container-div">
{% if slot.ok %}
{% with vis=slot.visualization %}
{% if vis.visualization.thumbnail %}
<img src="{{ MEDIA_URL }}{{ vis.visualization.thumbnail }}" alt="">
{% endif %}
<p>Please install the
<a href="http://get.adobe.com/flashplayer/">Adobe Flash Player</a>
to interact with this visualization.</p>
{% endwith %}
{% else %}
Viaualization "{{ slot.name }}" does not exist or has a bad type.
{% endif %}
</div>
{% endfor %}
</div>
{% endfor %}

{% endif %}

{% endblock %} 


{% block javascript %}
  {{ block.super }}
  {% include "_map_inc.html" %}
  <script type="text/javascript">

    // background layers
    var basemap = new L.MAPCTileLayer("basemap");

    // overlays
    var place = new L.GeoJSON();
    place.on("featureparse", function (e) {    
      e.layer.setStyle({
        "weight": 1,
        "opacity": 0.9,
        "color": "#F35A20",
        "fillOpacity": 0.4
      });
    });
    
    // map
    var boston = new L.LatLng(42.357778, -71.061667);
    var map = new L.Map("place_map",{
        minZoom: 9,
        maxZoom: 17,
        zoomControl: false,
        dragging: false,
        attributionControl: false
    })
    .setView(boston, 9)
    .addLayer(basemap);

    {% if GDAL_AVAILABLE %}
    // add place geometry
    place.addGeoJSON({{ place.geometry.geojson|safe }});
    map.addLayer(place);
    map.fitBounds(place.getBounds());
    {% endif %}

  </script>
{% endblock %}
